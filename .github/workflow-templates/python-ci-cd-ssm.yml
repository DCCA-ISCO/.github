name: Python CI/CD with SSM Deployment

on:
  push:
    branches: [ dev, master ]
  workflow_dispatch:  # Allows manual trigger

env:
  PYTHON_VERSION: '3.14'

jobs:
  # ============================================
  # JOB 1: Run Tests and Quality Checks
  # ============================================
  test-and-quality:
    name: Tests & Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt

    # ============================================
    # 1. UNIT TESTS
    # ============================================
    - name: Run Unit Tests
      run: |
        echo "========================================="
        echo "Running Unit Tests with pytest"
        echo "========================================="
        pytest tests/ -v --tb=short --cov=app --cov-report=term-missing --cov-report=xml
      continue-on-error: false

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

    # ============================================
    # 2. DEPENDENCY VULNERABILITY SCANNING
    # ============================================
    - name: Security - Dependency Vulnerability Scan (pip-audit)
      run: |
        echo "========================================="
        echo "Scanning for vulnerable dependencies"
        echo "========================================="
        pip-audit --desc --requirement requirements.txt
      continue-on-error: false

    - name: Security - Check with Safety
      run: |
        echo "========================================="
        echo "Running Safety security check"
        echo "========================================="
        safety check --json || true
      continue-on-error: true

    - name: Security - Bandit Security Linter
      run: |
        echo "========================================="
        echo "Running Bandit security analysis"
        echo "========================================="
        bandit -r . -f json -o bandit-report.json --exclude venv,tests || true
        bandit -r . -f screen --exclude venv,tests
      continue-on-error: true

    # ============================================
    # 3. LINTING
    # ============================================
    - name: Lint with flake8
      run: |
        echo "========================================="
        echo "Running flake8 linting"
        echo "========================================="
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude venv,tests
        # Exit-zero treats all errors as warnings
        flake8 . --count --max-complexity=10 --max-line-length=127 --statistics --exit-zero --exclude venv,tests
      continue-on-error: false

    - name: Lint with pylint
      run: |
        echo "========================================="
        echo "Running pylint analysis"
        echo "========================================="
        pylint **/*.py --exit-zero --max-line-length=127 || true
      continue-on-error: true

    # ============================================
    # 4. SMOKE TEST
    # ============================================
    - name: Smoke Test - Import Application
      run: |
        echo "========================================="
        echo "Running Smoke Test"
        echo "========================================="
        python -c "
        import sys
        import os
        from unittest.mock import patch

        # Mock environment variables (adjust for your application)
        with patch.dict(os.environ, {
            'REQUIRED_ENV_VAR': 'test-value'
        }):
            try:
                import app
                print('✓ App imports successfully')
                if hasattr(app, 'app'):
                    print('✓ Flask app initialized:', app.app.name)
                    print('✓ Routes registered:', len(list(app.app.url_map.iter_rules())))
                sys.exit(0)
            except Exception as e:
                print('✗ Smoke test failed:', str(e))
                sys.exit(1)
        "
      continue-on-error: false

    # ============================================
    # 5. TEST SUMMARY
    # ============================================
    - name: Test Summary
      if: always()
      run: |
        echo "========================================="
        echo "TEST PIPELINE SUMMARY"
        echo "========================================="
        echo "✓ Unit Tests: Completed"
        echo "✓ Security Scan: Completed"
        echo "✓ Linting: Completed"
        echo "✓ Smoke Test: Completed"
        echo "========================================="

  # ============================================
  # JOB 2: Deploy to Development Environment
  # ============================================
  deploy-dev:
    name: Deploy to Development
    needs: test-and-quality  # Only deploy if tests pass
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    environment: development

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Verify SSM Connectivity
      run: |
        echo "========================================="
        echo "Verifying SSM connectivity to development server"
        echo "========================================="
        aws ssm describe-instance-information \
          --filters "Key=InstanceIds,Values=${{ secrets.INSTANCE_ID }}" \
          --query "InstanceInformationList[0].[InstanceId,PingStatus,PlatformType,PlatformVersion]" \
          --output table
        echo "✓ SSM connectivity verified"

    - name: Deploy Application via SSM
      run: |
        echo "========================================="
        echo "Deploying to development server"
        echo "========================================="

        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "${{ secrets.INSTANCE_ID }}" \
          --document-name "AWS-RunPowerShellScript" \
          --comment "Deploy - Branch: ${{ github.ref_name }}" \
          --parameters 'commands=[
            "Write-Host \"=========================================\"",
            "Write-Host \"Starting Deployment\"",
            "Write-Host \"=========================================\"",
            "Write-Host \"Branch: ${{ github.ref_name }}\"",
            "Write-Host \"Commit: ${{ github.sha }}\"",
            "Write-Host \"Deployed by: ${{ github.actor }}\"",
            "Write-Host \"\"",
            "cd ${{ secrets.APP_PATH }}",
            "Write-Host \"Working directory: $(Get-Location)\"",
            "Write-Host \"\"",
            "Write-Host \"Creating backup...\"",
            "if (Test-Path \"backup_old\") { Remove-Item -Path \"backup_old\" -Recurse -Force -ErrorAction SilentlyContinue }",
            "if (Test-Path \"backup\") { Rename-Item -Path \"backup\" -NewName \"backup_old\" -ErrorAction SilentlyContinue }",
            "if (Test-Path \"*.py\") {",
            "  New-Item -Path \"backup\" -ItemType Directory -Force | Out-Null",
            "  Copy-Item -Path \"*.py\" -Destination \"backup\" -ErrorAction SilentlyContinue",
            "  Copy-Item -Path \"requirements.txt\" -Destination \"backup\" -ErrorAction SilentlyContinue",
            "  Write-Host \"✓ Backup created\"",
            "}",
            "Write-Host \"\"",
            "Write-Host \"Pulling latest code from ${{ github.ref_name }} branch...\"",
            "git fetch origin 2>&1",
            "git reset --hard origin/${{ github.ref_name }} 2>&1",
            "git pull origin ${{ github.ref_name }} 2>&1",
            "Write-Host \"✓ Code updated\"",
            "Write-Host \"\"",
            "Write-Host \"Updating dependencies...\"",
            "& \"${{ secrets.APP_PATH }}\\venv\\Scripts\\Activate.ps1\"",
            "python -m pip install --upgrade pip 2>&1 | Out-Null",
            "pip install -r requirements.txt --upgrade 2>&1",
            "deactivate",
            "Write-Host \"✓ Dependencies updated\"",
            "Write-Host \"\"",
            "Write-Host \"✓ Deployment complete\""
          ]' \
          --output-s3-bucket-name "${{ secrets.SSM_OUTPUT_BUCKET }}" \
          --output-s3-key-prefix "ssm-logs/development" \
          --query "Command.CommandId" \
          --output text)

        echo "Command ID: $COMMAND_ID"
        echo "COMMAND_ID=$COMMAND_ID" >> $GITHUB_ENV

        echo "Waiting for deployment to complete..."
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "${{ secrets.INSTANCE_ID }}" \
          --timeout 300

        echo "✓ Deployment command completed"

    - name: Get Deployment Output
      if: always()
      run: |
        echo "========================================="
        echo "Deployment Output"
        echo "========================================="
        aws ssm get-command-invocation \
          --command-id "${{ env.COMMAND_ID }}" \
          --instance-id "${{ secrets.INSTANCE_ID }}" \
          --query "[StandardOutputContent,StandardErrorContent]" \
          --output text

    - name: Restart Application via SSM
      run: |
        echo "========================================="
        echo "Restarting Application"
        echo "========================================="

        RESTART_COMMAND_ID=$(aws ssm send-command \
          --instance-ids "${{ secrets.INSTANCE_ID }}" \
          --document-name "AWS-RunPowerShellScript" \
          --comment "Restart Application" \
          --parameters 'commands=[
            "Write-Host \"=========================================\"",
            "Write-Host \"Restarting Application\"",
            "Write-Host \"=========================================\"",
            "Write-Host \"Stopping existing Python processes...\"",
            "$processes = Get-WmiObject Win32_Process -Filter \"name = '\''pythonw.exe'\''\" | Where-Object { $_.CommandLine -like \"*${{ secrets.SCRIPT_NAME }}*\" }",
            "if ($processes) {",
            "  foreach ($proc in $processes) {",
            "    Write-Host \"  Stopping PID: $($proc.ProcessId)\"",
            "    Stop-Process -Id $proc.ProcessId -Force -ErrorAction SilentlyContinue",
            "  }",
            "  Start-Sleep -Seconds 3",
            "  Write-Host \"✓ Stopped $($processes.Count) process(es)\"",
            "} else {",
            "  Write-Host \"  No running processes found\"",
            "}",
            "Write-Host \"\"",
            "Write-Host \"Starting application...\"",
            "cd ${{ secrets.APP_PATH }}",
            "$pythonw = Join-Path \"${{ secrets.APP_PATH }}\" \"venv\\Scripts\\pythonw.exe\"",
            "$script = Join-Path \"${{ secrets.APP_PATH }}\" \"${{ secrets.SCRIPT_NAME }}\"",
            "Start-Process -FilePath $pythonw -ArgumentList $script -WorkingDirectory \"${{ secrets.APP_PATH }}\" -WindowStyle Hidden",
            "Start-Sleep -Seconds 5",
            "Write-Host \"\"",
            "$running = Get-Process pythonw -ErrorAction SilentlyContinue | Where-Object { $_.Path -like \"*${{ secrets.APP_PATH }}*\" }",
            "if ($running) {",
            "  Write-Host \"✓ Application started (PID: $($running.Id))\"",
            "} else {",
            "  Write-Host \"⚠ Warning: Could not verify process\"",
            "}"
          ]' \
          --output-s3-bucket-name "${{ secrets.SSM_OUTPUT_BUCKET }}" \
          --output-s3-key-prefix "ssm-logs/development" \
          --query "Command.CommandId" \
          --output text)

        echo "Restart Command ID: $RESTART_COMMAND_ID"
        echo "RESTART_COMMAND_ID=$RESTART_COMMAND_ID" >> $GITHUB_ENV

        aws ssm wait command-executed \
          --command-id "$RESTART_COMMAND_ID" \
          --instance-id "${{ secrets.INSTANCE_ID }}" \
          --timeout 120

        echo "✓ Application restart completed"

    - name: Get Restart Output
      if: always()
      run: |
        echo "========================================="
        echo "Restart Output"
        echo "========================================="
        aws ssm get-command-invocation \
          --command-id "${{ env.RESTART_COMMAND_ID }}" \
          --instance-id "${{ secrets.INSTANCE_ID }}" \
          --query "[StandardOutputContent,StandardErrorContent]" \
          --output text

    - name: Health Check
      if: success()
      run: |
        echo "========================================="
        echo "Running Health Check"
        echo "========================================="
        sleep 10

        echo "Checking: https://${{ secrets.SERVER_HOST }}"

        if curl -k -s -o /dev/null -w "%{http_code}" --max-time 30 "https://${{ secrets.SERVER_HOST }}" | grep -q "200"; then
          echo "✓ Health check passed (HTTP 200)"
          echo "✓ Application is accessible"
        else
          echo "⚠ Health check warning: Could not verify HTTP 200"
          echo "Note: Application may still be starting up"
        fi

    - name: Deployment Summary
      if: always()
      run: |
        echo "========================================="
        echo "DEPLOYMENT SUMMARY"
        echo "========================================="
        echo "Environment: development"
        echo "Instance ID: ${{ secrets.INSTANCE_ID }}"
        echo "Server: ${{ secrets.SERVER_HOST }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Deployed by: ${{ github.actor }}"
        echo "========================================="

  # ============================================
  # JOB 3: Deploy to Production Environment
  # ============================================
  deploy-prod:
    name: Deploy to Production
    needs: test-and-quality  # Only deploy if tests pass
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    environment: production  # Requires approval

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Verify SSM Connectivity
      run: |
        echo "========================================="
        echo "Verifying SSM connectivity to production server"
        echo "========================================="
        aws ssm describe-instance-information \
          --filters "Key=InstanceIds,Values=${{ secrets.INSTANCE_ID }}" \
          --query "InstanceInformationList[0].[InstanceId,PingStatus,PlatformType,PlatformVersion]" \
          --output table
        echo "✓ SSM connectivity verified"

    - name: Deploy Application via SSM
      run: |
        echo "========================================="
        echo "Deploying to production server"
        echo "========================================="

        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "${{ secrets.INSTANCE_ID }}" \
          --document-name "AWS-RunPowerShellScript" \
          --comment "Deploy - Branch: ${{ github.ref_name }}" \
          --parameters 'commands=[
            "Write-Host \"=========================================\"",
            "Write-Host \"Starting Production Deployment\"",
            "Write-Host \"=========================================\"",
            "Write-Host \"Branch: ${{ github.ref_name }}\"",
            "Write-Host \"Commit: ${{ github.sha }}\"",
            "Write-Host \"Deployed by: ${{ github.actor }}\"",
            "Write-Host \"\"",
            "cd ${{ secrets.APP_PATH }}",
            "Write-Host \"Working directory: $(Get-Location)\"",
            "Write-Host \"\"",
            "Write-Host \"Creating backup...\"",
            "if (Test-Path \"backup_old\") { Remove-Item -Path \"backup_old\" -Recurse -Force -ErrorAction SilentlyContinue }",
            "if (Test-Path \"backup\") { Rename-Item -Path \"backup\" -NewName \"backup_old\" -ErrorAction SilentlyContinue }",
            "if (Test-Path \"*.py\") {",
            "  New-Item -Path \"backup\" -ItemType Directory -Force | Out-Null",
            "  Copy-Item -Path \"*.py\" -Destination \"backup\" -ErrorAction SilentlyContinue",
            "  Copy-Item -Path \"requirements.txt\" -Destination \"backup\" -ErrorAction SilentlyContinue",
            "  Write-Host \"✓ Backup created\"",
            "}",
            "Write-Host \"\"",
            "Write-Host \"Pulling latest code from ${{ github.ref_name }} branch...\"",
            "git fetch origin 2>&1",
            "git reset --hard origin/${{ github.ref_name }} 2>&1",
            "git pull origin ${{ github.ref_name }} 2>&1",
            "Write-Host \"✓ Code updated\"",
            "Write-Host \"\"",
            "Write-Host \"Updating dependencies...\"",
            "& \"${{ secrets.APP_PATH }}\\venv\\Scripts\\Activate.ps1\"",
            "python -m pip install --upgrade pip 2>&1 | Out-Null",
            "pip install -r requirements.txt --upgrade 2>&1",
            "deactivate",
            "Write-Host \"✓ Dependencies updated\"",
            "Write-Host \"\"",
            "Write-Host \"✓ Deployment complete\""
          ]' \
          --output-s3-bucket-name "${{ secrets.SSM_OUTPUT_BUCKET }}" \
          --output-s3-key-prefix "ssm-logs/production" \
          --query "Command.CommandId" \
          --output text)

        echo "Command ID: $COMMAND_ID"
        echo "COMMAND_ID=$COMMAND_ID" >> $GITHUB_ENV

        echo "Waiting for deployment to complete..."
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "${{ secrets.INSTANCE_ID }}" \
          --timeout 300

        echo "✓ Deployment command completed"

    - name: Get Deployment Output
      if: always()
      run: |
        echo "========================================="
        echo "Deployment Output"
        echo "========================================="
        aws ssm get-command-invocation \
          --command-id "${{ env.COMMAND_ID }}" \
          --instance-id "${{ secrets.INSTANCE_ID }}" \
          --query "[StandardOutputContent,StandardErrorContent]" \
          --output text

    - name: Restart Application via SSM
      run: |
        echo "========================================="
        echo "Restarting Application"
        echo "========================================="

        RESTART_COMMAND_ID=$(aws ssm send-command \
          --instance-ids "${{ secrets.INSTANCE_ID }}" \
          --document-name "AWS-RunPowerShellScript" \
          --comment "Restart Application" \
          --parameters 'commands=[
            "Write-Host \"=========================================\"",
            "Write-Host \"Restarting Application\"",
            "Write-Host \"=========================================\"",
            "Write-Host \"Stopping existing Python processes...\"",
            "$processes = Get-WmiObject Win32_Process -Filter \"name = '\''pythonw.exe'\''\" | Where-Object { $_.CommandLine -like \"*${{ secrets.SCRIPT_NAME }}*\" }",
            "if ($processes) {",
            "  foreach ($proc in $processes) {",
            "    Write-Host \"  Stopping PID: $($proc.ProcessId)\"",
            "    Stop-Process -Id $proc.ProcessId -Force -ErrorAction SilentlyContinue",
            "  }",
            "  Start-Sleep -Seconds 3",
            "  Write-Host \"✓ Stopped $($processes.Count) process(es)\"",
            "} else {",
            "  Write-Host \"  No running processes found\"",
            "}",
            "Write-Host \"\"",
            "Write-Host \"Starting application...\"",
            "cd ${{ secrets.APP_PATH }}",
            "$pythonw = Join-Path \"${{ secrets.APP_PATH }}\" \"venv\\Scripts\\pythonw.exe\"",
            "$script = Join-Path \"${{ secrets.APP_PATH }}\" \"${{ secrets.SCRIPT_NAME }}\"",
            "Start-Process -FilePath $pythonw -ArgumentList $script -WorkingDirectory \"${{ secrets.APP_PATH }}\" -WindowStyle Hidden",
            "Start-Sleep -Seconds 5",
            "Write-Host \"\"",
            "$running = Get-Process pythonw -ErrorAction SilentlyContinue | Where-Object { $_.Path -like \"*${{ secrets.APP_PATH }}*\" }",
            "if ($running) {",
            "  Write-Host \"✓ Application started (PID: $($running.Id))\"",
            "} else {",
            "  Write-Host \"⚠ Warning: Could not verify process\"",
            "}"
          ]' \
          --output-s3-bucket-name "${{ secrets.SSM_OUTPUT_BUCKET }}" \
          --output-s3-key-prefix "ssm-logs/production" \
          --query "Command.CommandId" \
          --output text)

        echo "Restart Command ID: $RESTART_COMMAND_ID"
        echo "RESTART_COMMAND_ID=$RESTART_COMMAND_ID" >> $GITHUB_ENV

        aws ssm wait command-executed \
          --command-id "$RESTART_COMMAND_ID" \
          --instance-id "${{ secrets.INSTANCE_ID }}" \
          --timeout 120

        echo "✓ Application restart completed"

    - name: Get Restart Output
      if: always()
      run: |
        echo "========================================="
        echo "Restart Output"
        echo "========================================="
        aws ssm get-command-invocation \
          --command-id "${{ env.RESTART_COMMAND_ID }}" \
          --instance-id "${{ secrets.INSTANCE_ID }}" \
          --query "[StandardOutputContent,StandardErrorContent]" \
          --output text

    - name: Health Check
      if: success()
      run: |
        echo "========================================="
        echo "Running Health Check"
        echo "========================================="
        sleep 10

        echo "Checking: https://${{ secrets.SERVER_HOST }}"

        if curl -k -s -o /dev/null -w "%{http_code}" --max-time 30 "https://${{ secrets.SERVER_HOST }}" | grep -q "200"; then
          echo "✓ Health check passed (HTTP 200)"
          echo "✓ Application is accessible"
        else
          echo "⚠ Health check warning: Could not verify HTTP 200"
          echo "Note: Application may still be starting up"
        fi

    - name: Deployment Summary
      if: always()
      run: |
        echo "========================================="
        echo "PRODUCTION DEPLOYMENT SUMMARY"
        echo "========================================="
        echo "Environment: production"
        echo "Instance ID: ${{ secrets.INSTANCE_ID }}"
        echo "Server: ${{ secrets.SERVER_HOST }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Deployed by: ${{ github.actor }}"
        echo "========================================="
        echo ""
        echo "Access your application at:"
        echo "  https://${{ secrets.SERVER_HOST }}"
        echo "========================================="
